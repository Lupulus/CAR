package Main;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.Socket;

import Command.CommandRequest;
import Command.CommandUser;

public class FtpRequest {
	
	String tab[];
	boolean getName = false, connected = false;
	boolean passive;
	BufferedReader in;
	PrintWriter out;
	File repertoire;
	
	public FtpRequest(Socket s) {
		repertoire = new File(System.getProperty("user.dir") + "/servorFile");
		try{
			this.in =  new BufferedReader( new InputStreamReader(s.getInputStream()));
			this.out = new PrintWriter(s.getOutputStream());
		}catch(Exception e){
			
		}
		System.out.println(repertoire.getAbsolutePath());
		
	}
	
	public void processRequest(){
		
			try {
				send(220, "connection");
				while(true){
				    String temp = in.readLine();
				    this.tab = temp.split(" ");
			    		    	
					if(connected){
						switch(tab[0].toUpperCase()){
							case "USER" : 
							case "PASS" : send(2, "Erreur déjà connecté");
							              break;
							case "PAVD" : this.processPAVD();
							              break;
							case "PORT" : this.processPORT();
							              break;
							case "RETR" : this.processRETR(tab[1]);
							              break;
							case "LIST" : this.processLIST();
							              break;
							case "STOR" : this.processSTOR(tab[1]);
							              break;
							case "QUIT" : this.processQUIT();
							              break;
							default     : //renvoyer une erreur
						}
					}else{
						switch(tab[0].toUpperCase()){
							case "USER" : this.processUSER(tab[1]); 
										  break;
							case "PASS" : this.processPASS(tab[1]);
							              break;
							case "PAVD" : 
							case "PORT" : 
							case "RETR" : 
							case "LIST" : 
							case "STOR" : 
							case "QUIT" : send(1, "Erreur Non connecté");
							              break;
							default     : //renvoyer une erreur
						}
					}
			}
	    } catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
		}
	}

	public void send(int number, String text){
		out.println(number + " " + text + "\r");
		out.flush();
	}
	
	public void processUSER(String name){
		@SuppressWarnings("unused")
		CommandRequest user = new CommandUser(this, name);
	}
	
	public void processPASS(String pass){
		if(getName){
			if(pass.equals("pass") ){
				send(230, "Login succesful");
				getName = false;
				connected = true;
			}else{
				send(000, "Mot de passe incorrect");
			}
		}else{
			send(000, "Erreur: utilisateur non renseigné");
		}
	}
	
	public void processPAVD(){
		Thread t = new Thread(){
			public void runnable(){
				return;
				//DataSocket ds = attendreCX();
			};
		};
		send(227, "");
		passive = true;
	}
	
	public void processPORT(){
		passive = false;
	}
	
	public void processRETR(String filename){
	    File source = new File(repertoire.getAbsolutePath() + "/" + filename);
	    File destination = new File("" + "/" + filename);

	    source.renameTo(destination);
	}
	
	public void processSTOR(String filename){
		File destination = new File(repertoire.getAbsolutePath() + "/" + filename);
	    File source = new File("" + "/" + filename);

	    source.renameTo(destination);
	}
	
	public void processLIST(){
		String[] files = repertoire.list();
		for(int i = 0; i<files.length; i++){
			out.println(files[i]);
			out.flush();
		}
	}
	
	public void processQUIT(){
		send(120, "Deconnexion");
		try{
			this.in.close();
			this.out.close();
		}catch(Exception e){
			e.printStackTrace();
		}
		
	}
}
